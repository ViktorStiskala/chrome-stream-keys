---
description: StreamKeys Extension - General Development Notes
alwaysApply: true
---

# StreamKeys Extension Development Notes

## Project Structure

```
stream-keys/
├── src/                     # Shared source files
│   ├── background.js        # Background script - routes to appropriate handler based on URL
│   ├── handlers/
│   │   ├── base.js          # Shared base handler with common functionality
│   │   ├── disney.js        # Disney+ service configuration
│   │   └── hbomax.js        # HBO Max service configuration
│   └── settings/
│       ├── settings.html    # Options page UI
│       ├── settings.js      # Settings page logic (storage, drag-drop)
│       └── settings.css     # Settings page styles
├── manifests/
│   ├── chrome.json          # Chrome Manifest V3 (service_worker)
│   └── firefox.json         # Firefox Manifest V3 (background.scripts)
├── logo/                    # Generated logos
├── assets/                  # Source assets
└── Makefile                 # Build script for Chrome and Firefox
```

## Adding New Streaming Services

1. Create new handler in `src/handlers/` folder (e.g., `netflix.js`)
2. Use `window.StreamKeys.createHandler(config)` with service-specific config
3. Add URL matching in `src/background.js` router
4. Add host permissions in both `manifests/chrome.json` and `manifests/firefox.json`
5. Add handler file to `Makefile` SRC_FILES list
6. Create service-specific Cursor rules file

## Base Handler Configuration

Service handlers provide a config object to `createHandler()`:

```javascript
window.StreamKeys.createHandler({
  name: 'Service Name',
  getPlayer: () => { /* return player element */ },
  getButton: (keyCode) => { /* return button for key */ },
  setupPlayerFocus: (player) => { /* optional: custom focus logic */ },
  onPlayerSetup: (player) => { /* optional: called on player setup */ },
  getOverlayContainer: () => { /* optional: container for click overlay */ },
  subtitles: {
    getAvailable: () => { /* return [{label, element, ...}] */ },
    getCurrentState: () => { /* return true if subtitles on */ },
    turnOff: () => { /* click off option */ },
    selectLanguage: (item) => { /* click language option */ }
  }
});
```

## Settings & Storage

- Settings stored in `chrome.storage.sync` under key `subtitleLanguages`
- Default languages: `['English', 'English [CC]', 'English CC']`
- Settings injected as `window.__streamKeysSettings` before handlers load
- Access in handlers via `window.__streamKeysSettings.subtitleLanguages`

## Keyboard Event Capture Strategy

1. Use `window.addEventListener('keydown', handler, true)` - the capture phase (`true`) intercepts events before they reach other handlers
2. `window` is preferred over `document` as it's higher in the capture chain
3. Also attach listener to `document.fullscreenElement` when in fullscreen mode
4. Attach listener directly to the player element as additional fallback

## Browser Security: Fullscreen Exit Focus Issue

**Problem:** After exiting fullscreen, browsers require "user activation" (a real click) before routing keyboard events to the page. This is a security feature that cannot be bypassed with JavaScript - `element.focus()`, synthetic events, and other tricks do not satisfy this requirement.

**Solution:** Create an invisible full-page overlay after fullscreen exit that captures the user's first click:
- Overlay covers entire viewport with `z-index: 2147483647`
- Completely transparent so user doesn't notice
- Captures click, removes itself, then focuses the player
- Click doesn't propagate to video (avoids unwanted pause/play)

## Script Injection

The background script injects in this order:
1. Settings as global variable (`window.__streamKeysSettings`)
2. Base handler (`handlers/base.js`)
3. Service-specific handler

All injected into MAIN world to share context with the streaming service's scripts.

## Logging Convention

- `console.info('[StreamKeys] ...')` - Extension loaded messages
- `console.warn('[StreamKeys] ...')` - Button not found or other recoverable issues

## Build System

The build system creates separate packages for Chrome and Firefox from shared source files:

- `make build` - Build both Chrome and Firefox extensions
- `make build-chrome` - Build Chrome extension only
- `make build-firefox` - Build Firefox extension only
- `make clean` - Remove build directory

Output:
- `build/chrome/stream-keys-chrome.zip`
- `build/firefox/stream-keys-firefox.zip`

When adding new handlers, update the `SRC_FILES` list in the Makefile.

## Manifest Differences

- **Chrome**: Uses `service_worker` in background config
- **Firefox**: Uses `scripts` array in background config, requires `browser_specific_settings.gecko.id`

Both manifests must be kept in sync for version numbers and permissions.

## Manifest Constraints

- The `description` field in manifest files has a maximum length of 132 characters.
