---
description: Safari build tool - Python/Textual TUI for building Safari extension
globs:
  - apps/extension/scripts/build-safari/**/*.py
  - apps/extension/scripts/build-safari/pyproject.toml
---

# Safari Build Tool

Python-based build tool for creating Safari extension packages (DMG and App Store).

## Hard Constraints

1. **Always use `uv` package manager** - Never use `pip`, `pip install`, or `python -m pip`. All package operations must go through `uv`.

2. **Reinstalling packages** - Use `uv sync --reinstall` to force reinstall, not `uv pip install --force-reinstall`.

3. **Running the tool** - Use `uv sync` to ensure dependencies (installs package as editable):
   ```bash
   cd scripts/build-safari && uv sync && uv run python -m build_safari [options]
   ```
   Or use npm scripts from `apps/extension/`:
   ```bash
   npm run build:safari
   ```
   
   Note: `uv sync` installs the package as **editable** by default, so code changes are picked up automatically. Use `--frozen` in CI for reproducibility.

4. **Python 3.14+** - No backward compatibility. Use modern typing syntax (`list[str]` not `List[str]`, `X | None` not `Optional[X]`).

## Architecture

### Entry Point

`__main__.py` - CLI entry point that:
- Parses arguments via `cli.py`
- Loads configuration from `pyproject.toml` and environment variables
- Dispatches to TUI (`BuildApp`) or simple console output (`SimpleUI`)

### Configuration (`config.py`)

Dataclasses for typed configuration:
- `DMGConfig` - DMG layout settings (icon positions, window size)
- `DeveloperConfig` - Apple credentials (from environment variables)
- `AppConfig` - App metadata (from `pyproject.toml` `[tool.build-safari]` section)
- `BuildConfig` - Combined runtime configuration

**Environment variables** (loaded from `.env` locally, CI secrets in GitHub):
- `APPLE_DEVELOPER_NAME` - Developer name for signing
- `APPLE_TEAM_ID` - Apple Team ID
- `APPLE_ID` - Apple ID for notarization
- `APPLE_APP_SPECIFIC_PASSWORD` - App-specific password for notarization

### Build Steps (`steps/`)

Abstract `BuildStep` base class with concrete implementations:
- `ViteBuildStep` - Runs Vite production build with `BROWSER=safari`
- `XcodeConvertStep` - Converts extension to Xcode project via `safari-web-extension-converter`
- `XcodeBuildStep` - Builds with `xcodebuild`, handles signing
- `SigningVerifyStep` - Verifies code signature integrity
- `DMGCreateStep` - Creates DMG using `dmgbuild` library
- `NotarizeStep` - Submits to Apple notarization service
- `StapleStep` - Staples notarization ticket to DMG
- `AppStorePackageStep` - Creates `.pkg` for App Store submission

### UI Layer (`ui/`)

- `BuildUI` (Protocol) - Common interface for UI implementations
- `BuildApp` (Textual) - Rich TUI with DataTable for steps, RichLog for output
- `SimpleUI` - Plain console output for `--simple` mode and CI

**TUI Features:**
- Live step progress table with status indicators
- Scrolling output log with ANSI color preservation
- Terminal restoration on exit (prints full log to scrollback)
- PTY support to preserve subprocess colors (`vite`, `xcodebuild`)

### Utilities (`utils/`)

- `ProcessRunner` - Async subprocess execution with optional PTY
- `OutputProcessor` - Handles terminal control sequences (`\r`, `\b`, escape codes)
- `BuildLogger` - Log file management with rotation

### Build Logs (`log/`)

Build logs are automatically saved to `scripts/build-safari/log/` with rotation:
- `build.log` - Most recent build (current)
- `build.log.1` - Previous build
- `build.log.2`, `build.log.3`, ... - Older builds

The number of log files to keep is configurable in `pyproject.toml`:
```toml
[tool.build-safari]
max_log_files = 5  # default
```

**For debugging build failures:** Read `log/build.log` to see the full output of the last build, including command output and error messages. ANSI color codes are stripped from log files for readability.

The log directory is git-ignored.

## CLI Options

```bash
python -m build_safari --help

Options:
  --dmg           Build DMG for direct distribution
  --rebuild-dmg   Rebuild DMG from existing build
  --appstore      Build App Store package (.pkg)
  --signed        Sign and notarize the build
  --simple        Use simple console output instead of TUI
```

## Common Commands

```bash
# Sync dependencies (from build-safari directory, installs as editable)
cd apps/extension/scripts/build-safari && uv sync

# Build unsigned DMG (local testing)
cd apps/extension/scripts/build-safari && uv run python -m build_safari --dmg

# Build signed + notarized DMG
cd apps/extension/scripts/build-safari && uv run python -m build_safari --dmg --signed

# Build App Store package
cd apps/extension/scripts/build-safari && uv run python -m build_safari --appstore

# Simple mode (no TUI, for CI or debugging)
cd apps/extension/scripts/build-safari && uv run python -m build_safari --dmg --simple

# Or use npm scripts from apps/extension/ (includes uv sync)
npm run build:safari
npm run build:safari:signed
npm run build:safari:appstore
```

## DMG Configuration

DMG settings are defined in `pyproject.toml` under `[tool.build-safari.dmg]` and passed directly to `dmgbuild` library (no separate settings file):

```toml
[tool.build-safari.dmg]
title = "Stream Keys"
icon = "../../../../assets/StreamKeys.icns"
background = "../../../../assets/dmg-background.png"
icon_size = 175
text_size = 12
window_position = [200, 120]
window_size = [660, 480]
app_position = [151, 279]       # Icon center coordinates
applications_position = [510, 274]
# Finder window options
show_pathbar = false
show_status_bar = false
show_sidebar = false
show_toolbar = false
```

## Adding New Build Steps

1. Create new file in `steps/` inheriting from `BuildStep`
2. Implement `name` property and `execute()` async method
3. Add to step sequence in `runner.py` `get_steps()` function
4. Use `runner.run_command()` for subprocess execution with output streaming
