---
description: Build commands and development workflow for the StreamKeys browser extension. Apply this rule when running npm scripts (dev, build, typecheck, lint, format), creating development or production builds, targeting different browsers (Chrome, Firefox, Safari), configuring the BROWSER environment variable, troubleshooting build output directories (build/dev/, build/production/), dealing with multi-browser compilation issues, or working with Safari DMG builds. Relevant keywords: npm run dev, npm run build, vite, webpack, bundle, compile, production, development mode, safari, dmg, appdmg, notarize.
globs:
  - "vite.config.ts"
  - "package.json"
  - "tsconfig.json"
  - "scripts/build-safari/**"
alwaysApply: false
---

# Build Commands

## Development

- `npm run dev` - Watch mode for development (Chrome by default)
- `BROWSER=firefox npm run dev` - Firefox dev mode

## Production

- `npm run build` - Production build (Chrome by default)
- `npm run build:firefox` - Firefox build

## Safari Builds

Safari builds use the modular `scripts/build-safari/` directory with different modes:

- `npm run build:safari` - Local testing DMG (ad-hoc signed, not notarized)
- `npm run build:safari:signed` - Distribution DMG (signed + notarized)
- `bash scripts/build-safari/main.sh --appstore` - App Store package

### Build Script Structure

```
scripts/build-safari/
├── main.sh           # Entry point, argument parsing, build flow
├── config.sh         # App metadata, paths, signing identities
├── ui.sh             # Colors, TTY detection, live progress header
├── steps.sh          # step(), step_check(), step tracking
├── helpers.sh        # info, success, error, run, notarytool, cleanup
└── dmg-config.json   # appdmg configuration
```

### Build Script Options

```bash
# Local testing (no signing credentials needed)
./scripts/build-safari/main.sh --dmg

# Distribution (requires APPLE_TEAM_ID, APPLE_ID, APPLE_APP_SPECIFIC_PASSWORD)
./scripts/build-safari/main.sh --dmg --signed

# Rebuild DMG from existing production build (skips Vite, Xcode conversion, Xcode build)
./scripts/build-safari/main.sh --rebuild-dmg           # unsigned
./scripts/build-safari/main.sh --rebuild-dmg --signed  # signed + notarized

# App Store (requires APPLE_TEAM_ID)
./scripts/build-safari/main.sh --appstore
```

The `--rebuild-dmg` option is useful when you need to regenerate the DMG without rebuilding the entire app. It validates that the existing build exists and has a valid signature (if --signed).

### Styled DMG Installer

Safari DMGs are created with `appdmg` using a custom background image showing:
- Stream Keys app icon (left, 150x150 at 103,162)
- Arrow graphic pointing to Applications folder
- Applications folder shortcut for drag-and-drop installation (150x150 at 408,162)

Configuration: `scripts/build-safari/dmg-config.json` (paths relative to config file location)
Background: `assets/dmg-background.png` (660x400px, or 1320x800 for Retina)

### Live Progress Display

In TTY mode, the build shows a live ASCII table with columns for Status, Step, and Details:

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║ Stream Keys - Safari Extension Build                    Signed + Notarized DMG║
╠═══════════╦═══════╦═══════════════════════════════════════════════════════════╣
║ Status    ║ Step  ║ Details                                                   ║
╠═══════════╬═══════╬═══════════════════════════════════════════════════════════╣
║ [SUCCESS] ║ [1/7] ║ Building Safari extension...                              ║
║ [RUNNING] ║ [2/7] ║ Converting to Xcode project...                            ║
...
```

Status indicators: `[RUNNING]` (yellow), `[SUCCESS]` (green), `[FAILED ]` (red), `[PENDING]` (dim)

When a command produces no output for 2+ seconds, the step line shows "(no output for Xs)" with live updates. This provides feedback during long-running operations like `npx appdmg`.

Falls back to simple output in CI environments.

## Code Quality

- `npm run typecheck` - Type checking without emit
- `npm run lint` - Run ESLint
- `npm run lint:fix` - Run ESLint with auto-fix
- `npm run format` - Format code with Prettier
- `npm run format:check` - Check formatting without changes
- `npm run check` - Run all checks (typecheck + lint + format)

## Multi-Browser Builds

Set `BROWSER` environment variable to target different browsers:
- `chrome` (default) - Chromium-based browsers (Chrome, Edge, Brave)
- `firefox` - Firefox desktop
- `safari` - Safari (macOS only, use build:safari scripts)

Output directories:
- Dev: `build/dev/{browser}/extension`
- Prod: `build/production/{browser}/extension`
- Safari DMG: `build/production/safari/stream-keys-safari.dmg`

## Browser-Specific Manifest Transformations

The `vite.config.ts` transforms the manifest for browser compatibility:

### Background Script Format

- **Chrome**: Uses `service_worker` (Manifest V3 standard)
- **Firefox/Safari**: Uses `scripts` array (these browsers don't support service workers in extensions)

```json
// Chrome
"background": { "service_worker": "src/background/index.js" }

// Firefox & Safari
"background": { "scripts": ["src/background/index.js"] }
```

### Main World Injection (Safari Compatibility)

Safari doesn't support `world: "MAIN"` in:
- `manifest.json` content_scripts
- `browser.scripting.executeScript()`

**Solution**: Use script tag injection instead. See the handlers.mdc rule for details on the shadow patcher loader pattern.
